@(problems: List[Problem], assignmentID: Long, userID: String, preFix: String, duration: Long)


<script type='text/javascript'>
        function onLoadHandler() {
            var iframes = document.getElementsByClassName('exercise-iframe')

            for (i = 0; i < iframes.length; i++) {
                var str = iframes[i].src;
                var patt = new RegExp("play.codecheck.ws");

                if (patt.test(str) && str.includes("?")) {
                    iframes[i].src = iframes[i].src + "&scoreCallback=" + window.location.protocol + "//" + window.location.host + "@preFix" + "/submissions/" + "@assignmentID" + "/" + "@userID" + "/" + iframes[i].id;
                }
                else if (patt.test(str)) {
                    iframes[i].src = iframes[i].src + "?scoreCallback=" + window.location.protocol + "//" + window.location.host + "@preFix" + "/submissions/" + "@assignmentID" + "/" + "@userID" + "/" + iframes[i].id;
                }
                else
                    iframes[i].src = iframes[i].src;
            }
        }

        //window.onload = onLoadHandler;
</script>

<script type="text/javascript">
        var exerciseScores = [];

        function checkScores() {
            exerciseScores = []; // reset the scores array to prevent incorrect data when button is pressed again
            $('.exercise-iframe').each(function (_, iframe) {
                iframe.contentWindow.postMessage("scores", "*")
            });
            return false
        }

        function receiveMessage(event) {
            var iframes = document.getElementsByClassName('exercise-iframe')
            exerciseScores.push(event.data)
            if (exerciseScores.length === iframes.length) {
                $.ajax({
                    url: '@preFix/send-interactivescore/@assignmentID',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(exerciseScores),
                    success: function (msg) {
                        var response = document.getElementById('response')
                        response.innerHTML = "Your partially complete assignment is saved!";
                        setTimeout(function () {
                            $("#response").hide();
                        }, 4000);
                    }
                });
            }
        }

        window.addEventListener("message", receiveMessage, false);
        setInterval(checkScores, 60000);
</script>

<script type ="text/javascript" >
        var tim;
        var min = @duration;
        var sec = 0;
        var f = new Date();
        function f1() {
            f2();
            document.getElementById("starttime").innerHTML = "Assignment started at " + f.getHours() + ":" + f.getMinutes();


        }
        function f2() {
            if (parseInt(sec) > 0) {
                sec = parseInt(sec) - 1;
                document.getElementById("showtime").innerHTML = "Time left " + min + " Minutes :" + sec + " Seconds";
                tim = setTimeout("f2()", 1000);
            }
            else {
                if (parseInt(sec) == 0) {
                    min = parseInt(min);
                    if (parseInt(min) == 0) {
                        clearTimeout(tim);
                        alert("Time over. Your grade will be saved in canvas.");
                        location.href = "@preFix/send-score/@assignmentID/@userID";
                    }
                    else {
                        sec = 60;
                        min = parseInt(min) - 1;
                        document.getElementById("showtime").innerHTML = "Your Left Time  is :" + min + " Minutes ," + sec + " Seconds";
                        tim = setTimeout("f2()", 1000);
                    }
                }

            }
        }
</script>

<script type="text/javascript">
        /**
         * Sends submission to the given iframe to populate its ace editor with the student's previously submitted code
         */
        function populateCodeEditors() {
            @for(problem <- problems) {
                // Get student's most recently submitted work
                var studentWork = @Html@{
                    var studentWork = "{}";

                    val submissions = problem.getSubmissions();
                    if (!submissions.isEmpty()) {
                        submissions.sortBy(_.submissionId);

                        for (submission <- submissions) {
                            if (submission.getStudentId().equals(userID)) {
                                studentWork = submission.getContent();
                            }
                        }
                    }

                   studentWork
                };

                // Didn't find submission for given studentID/problemID
                if (jQuery.isEmptyObject(studentWork)) {
                    return;
                }

                // Post message to iframe to populate the editor
                var iframe = document.getElementById('@problem.getProblemId()');
                iframe.contentWindow.postMessage({query: 'restoreState', studentWork: studentWork}, '*');
            }
        }
</script>

<script type="text/javascript">
        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            } else {
                window.onload = function () {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }
        //    addLoadEvent(onLoadHandler);
        addLoadEvent(f1);
        addLoadEvent(populateCodeEditors);
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<style>
        .warning {
            background-color: #FFF8C4;
            padding: 1em;
        }

        .duration {
            position: fixed;
            right: 0;
            top: 50%;
            width: 10em;
            background-color: #FFF8C4;
            margin-top: -2.5em;
            border-style: solid;
            color: red;
        }
</style>
@if(flash.containsKey("warning")) {
    <p class="warning">
        This LTI tool is launched as an assignment in the teacher view.
    </p>
}

<div class="duration">
    <div id="starttime"></div><br />
    <div id="showtime"></div>
</div>

@*TODO: Stop using iframes and grab the HTML and plop it inside instead.*@
@for(problem <- problems) {
    <iframe style='width: 100% ;
        height: 50em ;' class='exercise-iframe'
    id= @problem.problemId src=@{
        val problemURL = problem.getProblemUrl().trim();

        var ret = new StringBuilder(problemURL);
        if(problemURL.contains("play.codecheck.ws")) {

            if(problemURL.contains("?")) {
                ret.append('&');
            } else {
                ret.append('?');
            }

            ret.append("scoreCallback=");

            ret.append("https://");
            ret.append("play.codecheck.ws");
            ret.append(preFix + "/");
            ret.append("submissions/");
            ret.append(assignmentID + "/");
            ret.append(userID + "/");
            ret.append(problem.getProblemId());
        }

        ret.toString()
    }></iframe>

}
<div id='response'></div>

<input type="button" id = 'btn' value="Save my work" onclick="checkScores(event)"/>
<a href="@routes.GradeSubmitterController.submitGradeToCanvas(assignmentID, userID)"><button>Record my score</button></a>

